# Objective and subjective testing pipeline for JPEG 2000 (Kakadu 8.0.5) + H.265/HEVC (HM 16.20)

## Comments on inner workings

- Uses an exhaustive QP binary search for rate matching per color channel in case of H.265/HEVC.
- JPEG 2000 is used at the best approximative rates that H.265/HEVC achieved per color channel.
- `ObjTest` and `subjTest` will by default use different viewpoints, which may be changed via `holoread_PL` and in this script, respectively. Separate sets of reconstructions will be created for either case.


## Comments on Configurations

- An arbitrary list of bitrates may be specified.
- An arbitrary list of distortions may be specified, and implemented in `Pipeline_Compress.m` + changing in-/outfile prefixes in `ObjEvaluateCompressedHolograms.m`, `ST_RenderCompressedHolograms.m`
- Any selection of Compression, objectiveTest, subjectiveTest (to be processed) may be done via `"testParams.compress"`, `"testParams.objTest"`, `"testParams.subjTest"`.
- Compressed data may be forcibly removed via `"testParams.discardCompressedData"`.
- Diffraction Limited reconstructions may be activated with the flag "`testParams.lowResSubjTest"`. Note, compatible with `testParams.subjTestVideo == true`.
  - Note: Diffraction limited and regular reconstructions may be kept simultaneously. Files will get `"_LR"` suffix in the former case.
- Subjective Test video sequences may be activated with the flag `"testParams.subjTestVideo"`.


## Comments on viewpoints and reconstructions wrt. **objTest**, **subjTest**

- Subjective test videos are generated by following a list of viewpoints. Please specify, in `Hsubj: rec_dists, ap_sizes, h_pos, v_pos` accordingly. Per quantity: either as a list/cell array of the length of viewpoints or scalar. See also input argument specification of nrsh_video.m.
- By default clipping of all reconstructions is done at the same absolute thresholds as for the ground_truth. For the subjective test videos, the default is clipping according to the first frame.
- By default for `"testParams.lowResSubjTest = false"` test videos will be bi-linearly resized to 2048x2048.
- `"testParams.lowResSubjTest = true"` will calculate appropriate bounds for non-Fourier holograms (i.e. not wut_disp_on_axis, interfere4). For Fourier holograms a bi-linear resize to the size specified in the nrsh-config files (`recons_img_size`) or `min(hol_rendered)*[1,1]` will be performed, using the assumption bandwidth == aperture size.


## Comments on OUTPUT

- A log file will be written for the main_degrade script in `pwd()`.
- All files written by NRSH, reside in `pwd()/figures`.
- All NRSH files are prefixed, e.g. `ObjTest_holo_JPEG2000_10bpp_astronaut_000_0_0_[2588x2588]_-0.172.png`.
- All subjective test videos are prefixed as well and are written to `pwd()/figures`, incl. a separate log file. Temporary frames will be deleted. Videos will be named as, e.g.: `SubjTest_GT__astronaut_000_nFrames7_at20FPS_LR.mp4`. Videos will be written with H.264/AVC using `ffmpeg -c:v libx264 -qp 0`
- All compressed files are written to `"Folders.Forkfolder=['plenofolder/' plane 'Plane/' distStr '/']`" to be specified below.
- The configurations (viewpoints etc.) of the `objTest` and `subjTest` are written to `plenofolder/{CfgObjTest.m, CfgSubjTest.m}`.
- Quanitzation information is kept in `plenofolder/QuantInfo_{holo,obj}Plane.mat`.
- All objective ratings are written to `plenofolder/Metrics.mat`. It contains:
    - **`"RA"@numeric`** : bitrate list
    - **`"distL"`** : distortion list@cell
    - **`"M"@struct`** : rating scores are structured as follows:
        - **`M.(plane).(distStr).bitrateMap@table`** : map of bitrates achieved, in the same order as sort("RA")
        - **`M.(plane).(distStr).qpnMap@table`** : map of searched QPNs to achieved bitrates (for distStr=="hm" only)
        - **`M.(plane).(distStr).{ref,deg}@struct-array`** : objective scores wrt. to ground truth non-quantized ("ref") and 16bit quantized ("deg") The array has length `numel("RA")` and follows sort("RA").
        - **`M.(plane).(distStr).{ref,deg}.{ssnr_hol,ssim_hol}@numerics`** : metrics evaluated in the hologram plane (per color channel)
        - **`M.(plane).(distStr).{ref,deg}.view_results@table`** : metrics evaluated on the various viewpoints (per color channel) + averages over viewpoints


## Further comments

- This pipeline is based on NRSHv5.
- No separate propagations for complex-valued wavefields to the object/hologram plane are used anymore.
- ATTENTION: Please install Kakadu first.
  https://kakadusoftware.com/downloads/
- ATTENTION: Please place ffmpeg.exe first to: Folders.nrshfolder/../ffmpeg/ffmpeg.exe
  https://ffmpeg.org/download.html
- ATTENTION: Please install JPEG-XL binaries, if needed.


# How to use:

1. Specify what to do (Compress, SubjTest, ObjTest) and how to do it using the flags
2. Specify bitrates.
3. Specify distortions to be studied.
4. Specify directories.
5. Specify filenames/holograms to be processed.

ATTENTION: Ensure that holoread_PL.m contains appropriate information for objTest viewpoints + is read to load your hologram.


Rewrite: T. Birnbaum
Based on version 1.4 by Raees K. M. and T. Birnbaum
ETRO-VUB, imec
Version 6.1, modular, low RAM complexity, minimal HDD footprint
21.12.2021